package com.example.shenghuobang.Charge;

import android.content.Context;
import android.os.Handler;
import android.os.Message;
import android.support.v4.view.ViewPager.LayoutParams;
import android.util.AttributeSet;
import android.view.LayoutInflater;
import android.view.MotionEvent;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.LinearLayout;
import android.widget.ListView;
import android.widget.ProgressBar;
import android.widget.RelativeLayout;
import android.widget.TextView;

import com.fay.message.R;
import com.fay.widget.ScrollOverListView.OnScrollOverListener;





/**
 * @function ä¸‹æ‹‰åˆ·æ–°æ§ä»¶   çœŸæ­£å®ç°ä¸‹æ‹‰åˆ·æ–°çš„æ˜¯è¿™ä¸ªæ§ä»¶ï¼?ScrollOverListViewåªæ˜¯æä¾›è§¦æ‘¸çš„äº‹ä»¶ç­‰
 * @version 1.0
 */

public class PullDownView extends LinearLayout implements OnScrollOverListener {

	private static final int START_PULL_DEVIATION = 50; // ç§»åŠ¨è¯¯å·®
	private static final int WHAT_DID_MORE = 5; // Handler what å·²ç»è·å–å®Œæ›´å¤?
	private static final int WHAT_DID_REFRESH = 3; // Handler what å·²ç»åˆ·æ–°å®?
	/**åº•éƒ¨æ›´å¤šçš„æŒ‰é”?*/
	private RelativeLayout mFooterView;
	/**åº•éƒ¨æ›´å¤šçš„æŒ‰é”?*/
	private TextView mFooterTextView;
	/**åº•éƒ¨æ›´å¤šçš„æŒ‰é”?*/
	private ProgressBar mFooterLoadingView;
	/**å·²ç»å«æœ‰ ä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½çš„åˆ—è¡?*/
	private ScrollOverListView mListView;
	/**åˆ·æ–°å’Œæ›´å¤šçš„äº‹ä»¶æ¥å£**/
	private OnPullDownListener mOnPullDownListener;
	private float mMotionDownLastY; // æŒ‰ä¸‹æ—¶å?çš„Yè½´åæ ?
	private boolean mIsFetchMoreing; // æ˜¯å¦è·å–æ›´å¤šä¸?
	private boolean mIsPullUpDone; // æ˜¯å¦å›æ¨å®Œæˆ
	private boolean mEnableAutoFetchMore; // æ˜¯å¦å…è®¸è‡ªåŠ¨è·å–æ›´å¤š

	public PullDownView(Context context, AttributeSet attrs) {
		super(context, attrs);
		initHeaderViewAndFooterViewAndListView(context);
	}

	public PullDownView(Context context) {
		super(context);
		initHeaderViewAndFooterViewAndListView(context);
	}

	/*
	 * ================================== Public method å¤–éƒ¨ä½¿ç”¨ï¼Œå…·ä½“å°±æ˜¯ç”¨è¿™å‡ ä¸ªå°±å¯ä»¥äº?
	 */

	/**
	 * åˆ·æ–°å’Œè·å–æ›´å¤šäº‹ä»¶æ¥å?
	 */
	public interface OnPullDownListener {
		/**åˆ·æ–°äº‹ä»¶æ¥å£  è¿™é‡Œè¦æ³¨æ„çš„æ˜¯è·å–æ›´å¤šå®Œ è¦å…³é—?åˆ·æ–°çš„è¿›åº¦æ¡RefreshComplete()**/
		void onRefresh();
		/**åˆ·æ–°äº‹ä»¶æ¥å£  è¿™é‡Œè¦æ³¨æ„çš„æ˜¯è·å–æ›´å¤šå®Œ è¦å…³é—?æ›´å¤šçš„è¿›åº¦æ¡ notifyDidMore()**/
		void onMore();
	}

	/**
	 * é€šçŸ¥å·²ç»è·å–å®Œæ›´å¤šäº†ï¼Œè¦æ”¾åœ¨Adapter.notifyDataSetChangedåé¢
	 * å½“ä½ æ‰§è¡Œå®Œæ›´å¤šä»»åŠ¡ä¹‹åï¼Œè°ƒç”¨è¿™ä¸ªnotyfyDidMore() æ‰ä¼šéšè—åŠ è½½åœˆç­‰æ“ä½œ
	 */
	public void notifyDidMore() {
		mUIHandler.sendEmptyMessage(WHAT_DID_MORE);
	}

	/** åˆ·æ–°å®Œæ¯• å…³é—­å¤´éƒ¨æ»šåŠ¨æ?**/
	public void RefreshComplete() {
		mUIHandler.sendEmptyMessage(WHAT_DID_REFRESH);
	}

	/**
	 * è®¾ç½®ç›‘å¬å™?
	 * 
	 * @param listener
	 */
	public void setOnPullDownListener(OnPullDownListener listener) {
		mOnPullDownListener = listener;
	}

	/**
	 * è·å–å†…åµŒçš„listview
	 * 
	 * @return ScrollOverListView
	 */
	public ListView getListView() {
		return mListView;
	}

	/**
	 * æ˜¯å¦å¼?¯è‡ªåŠ¨è·å–æ›´å¤š è‡ªåŠ¨è·å–æ›´å¤šï¼Œå°†ä¼šéšè—footerï¼Œå¹¶åœ¨åˆ°è¾¾åº•éƒ¨çš„æ—¶å?è‡ªåŠ¨åˆ·æ–°
	 * 
	 * @param index
	 *            å€’æ•°ç¬¬å‡ ä¸ªè§¦å?
	 */
	public void enableAutoFetchMore(boolean enable, int index) {
		if (enable) {
			mListView.setBottomPosition(index);
			//mFooterLoadingView.setVisibility(View.VISIBLE);
		} else {
			mFooterTextView.setText("ç‚¹å‡»åŠ è½½æ›´å¤š");//ä¸è‡ªåŠ¨åŠ è½?
			mFooterLoadingView.setVisibility(View.GONE);
		}
		mEnableAutoFetchMore = enable;
	}

	/*
	 * ================================== Private method å…·ä½“å®ç°ä¸‹æ‹‰åˆ·æ–°ç­‰æ“ä½?
	 * 
	 * ==================================
	 */

	/**
	 * åˆå§‹åŒ–ç•Œé?
	 */
	private void initHeaderViewAndFooterViewAndListView(Context context) {
		setOrientation(LinearLayout.VERTICAL);

		/**
		 * è‡ªå®šä¹‰è„šéƒ¨æ–‡ä»?
		 */
		mFooterView = (RelativeLayout) LayoutInflater.from(context).inflate(
				R.layout.pulldown_footer, null);
		mFooterTextView = (TextView) mFooterView
				.findViewById(R.id.pulldown_footer_text);
		mFooterLoadingView = (ProgressBar) mFooterView
				.findViewById(R.id.pulldown_footer_loading);
		mFooterView.setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				if (!mIsFetchMoreing) {

					mIsFetchMoreing = true;
					mFooterTextView.setText("åŠ è½½æ›´å¤šä¸?..");
					mFooterLoadingView.setVisibility(View.VISIBLE);
					mOnPullDownListener.onMore();
				}
			}
		});

		/*
		 * ScrollOverListView åŒæ ·æ˜¯è?è™‘åˆ°éƒ½æ˜¯ä½¿ç”¨ï¼Œæ‰€ä»¥æ”¾åœ¨è¿™é‡?åŒæ—¶å› ä¸ºï¼Œéœ€è¦å®ƒçš„ç›‘å¬äº‹ä»?
		 */
		mListView = new ScrollOverListView(context);
		mListView.setOnScrollOverListener(this);
		mListView.setCacheColorHint(0);
		addView(mListView, LayoutParams.FILL_PARENT, LayoutParams.FILL_PARENT);

		// ç©ºçš„listener
		mOnPullDownListener = new OnPullDownListener() {
			@Override
			public void onRefresh() {
			}

			@Override
			public void onMore() {
			}
		};

		mListView.addFooterView(mFooterView);
		//mListView.setAdapter(mListView.getAdapter());

	}

	private Handler mUIHandler = new Handler() {

		@Override
		public void handleMessage(Message msg) {
			switch (msg.what) {
			case WHAT_DID_REFRESH: {
				mListView.onRefreshComplete();
				return;
			}

			case WHAT_DID_MORE: {
				mIsFetchMoreing = false;
				mFooterTextView.setText("æ›´å¤š");
				mFooterLoadingView.setVisibility(View.GONE);
			}
			}
		}

	};


	/**
	 * æ¡ç›®æ˜¯å¦å¡«æ»¡æ•´ä¸ªå±å¹•
	 */
	private boolean isFillScreenItem() {
		final int firstVisiblePosition = mListView.getFirstVisiblePosition();
		final int lastVisiblePostion = mListView.getLastVisiblePosition()
				- mListView.getFooterViewsCount();
		final int visibleItemCount = lastVisiblePostion - firstVisiblePosition
				+ 1;
		final int totalItemCount = mListView.getCount()
				- mListView.getFooterViewsCount();

		if (visibleItemCount < totalItemCount)
			return true;
		return false;
	}

	/*
	 * ================================== å®ç° OnScrollOverListeneræ¥å£
	 */

	@Override
	public boolean onListViewTopAndPullDown(int delta) {

		return true;
	}

	@Override
	public boolean onListViewBottomAndPullUp(int delta) {
		if (!mEnableAutoFetchMore || mIsFetchMoreing)
			return false;
		// æ•°é‡å……æ»¡å±å¹•æ‰è§¦å?
		if (isFillScreenItem()) {
			mIsFetchMoreing = true;
			mFooterTextView.setText("åŠ è½½æ›´å¤šä¸?..");
			mFooterLoadingView.setVisibility(View.VISIBLE);
			mOnPullDownListener.onMore();
			return true;
		}
		return false;
	}

	@Override
	public boolean onMotionDown(MotionEvent ev) {
		mIsPullUpDone = false;
		mMotionDownLastY = ev.getRawY();

		return false;
	}

	@Override
	public boolean onMotionMove(MotionEvent ev, int delta) {
		// å½“å¤´éƒ¨æ–‡ä»¶å›æ¨æ¶ˆå¤±çš„æ—¶å?ï¼Œä¸å…è®¸æ»šåŠ¨
		if (mIsPullUpDone)
			return true;

		// å¦‚æœå¼?§‹æŒ‰ä¸‹åˆ°æ»‘åŠ¨è·ç¦»ä¸è¶…è¿‡è¯¯å·®å€¼ï¼Œåˆ™ä¸æ»‘åŠ¨
		final int absMotionY = (int) Math.abs(ev.getRawY() - mMotionDownLastY);
		if (absMotionY < START_PULL_DEVIATION)
			return true;

		return false;
	}

	@Override
	public boolean onMotionUp(MotionEvent ev) {
		if (ScrollOverListView.canRefleash) {
			ScrollOverListView.canRefleash = false;
			mOnPullDownListener.onRefresh();
		}
		return false;
	}

	/**éšè—å¤´éƒ¨ ç¦ç”¨ä¸‹æ‹‰æ›´æ–°**/
	public void setHideHeader() {
		mListView.showRefresh = false;
	}

	/**æ˜¾ç¤ºå¤´éƒ¨ ä½¿ç”¨ä¸‹æ‹‰æ›´æ–°**/
	public void setShowHeader() {
		mListView.showRefresh = true;
	}

	/**éšè—åº•éƒ¨ ç¦ç”¨ä¸Šæ‹‰æ›´å¤š**/
	public void setHideFooter() {
		mFooterView.setVisibility(View.GONE);
		mFooterTextView.setVisibility(View.GONE);
		mFooterLoadingView.setVisibility(View.GONE);
		enableAutoFetchMore(false, 1);
	}
	
	
	/**æ˜¾ç¤ºåº•éƒ¨ ä½¿ç”¨ä¸Šæ‹‰æ›´å¤š**/
	public void setShowFooter() {
		mFooterView.setVisibility(View.VISIBLE);
		mFooterTextView.setVisibility(View.VISIBLE);
		//mFooterLoadingView.setVisibility(View.VISIBLE);
		enableAutoFetchMore(true, 1);
	}

}
