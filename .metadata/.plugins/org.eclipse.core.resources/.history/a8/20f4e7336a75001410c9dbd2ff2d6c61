package com.example.shenghuobang.Password;

import java.io.File;
import java.util.ArrayList;
import java.util.List;

import sqliteDataBase.Model.Password;
import sqliteDataBase.Model.Unforget;

import com.example.shenghuobang.FileOper;
import com.example.shenghuobang.R;
import com.example.shenghuobang.R.id;
import com.example.shenghuobang.R.layout;
import com.example.shenghuobang.Unforget.UnforgetActivity;
import com.example.shenghuobang.Unforget.UnforgetAdapter;
import com.example.shenghuobang.Unforget.UpdateUnforgetActivity;

import android.app.Activity;
import android.app.AlertDialog;
import android.content.DialogInterface;
import android.content.Intent;
import android.database.Cursor;
import android.os.Bundle;
import android.util.Log;
import android.view.Gravity;
import android.view.View;
import android.view.ViewGroup;
import android.view.View.OnClickListener;
import android.view.ViewGroup.LayoutParams;
import android.widget.AdapterView;
import android.widget.Button;
import android.widget.GridView;
import android.widget.TextView;
import android.widget.Toast;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.AdapterView.OnItemLongClickListener;

public class PasswordActivity extends Activity {
	
	private Button btnAddPassword;
	
	private GridView gridViewPassword;
	
	private sqliteDataBase.Bll.Password bllPassword;
	private List<sqliteDataBase.Model.Password> listPassword;
	
	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_password);
		
		bllPassword = new sqliteDataBase.Bll.Password(this);
		
		gridViewPassword = (GridView) findViewById(R.id.gridViewPassword);
		showGridViewData();
		
		gridViewPassword.setOnItemClickListener(new OnItemClickListener() { 
			
            public void onItemClick(AdapterView<?> parent, View v, int position, long id) 
            { 
            	
            	Log.i("tag", "按钮按下"); 
            	
                Password password = listPassword.get(position);
                 
                
                Log.i("tag", "读数据成功");	

				Intent intent = new Intent();
				intent .putExtra("name", password.getName());
				intent .putExtra("passWord", password.getPassWord());
				intent.putExtra("soundFileName", password.getSoundFileName());
				
                intent.setClass(PasswordActivity.this, UpdatePasswordActivity.class);
                startActivityForResult(intent, 1);
            } 
        }); 
		
		gridViewPassword.setOnItemLongClickListener(new OnItemLongClickListener() {

			@Override
			public boolean onItemLongClick(AdapterView<?> parent, View arg1,
					int position, long id) {
				
				 final Password password = listPassword.get(position);
				 
				AlertDialog.Builder builder = new AlertDialog.Builder(PasswordActivity.this);
				
				builder.setIcon(R.drawable.ic_launcher);
				builder.setTitle("你确定要删除吗");
				builder.setPositiveButton("确定", new DialogInterface.OnClickListener() {
					public void onClick(DialogInterface dialog, int whichButton) {
						
						FileOper fileOper = new FileOper();
						File file = new File(pathName +"/"+ password.getSoundFileName());
						fileOper.deleteFile(file);
						bllPassword.delete(password.getId());
					}
				});
				builder.setNegativeButton("取消", new DialogInterface.OnClickListener() {
					public void onClick(DialogInterface dialog, int whichButton) {
						Toast.makeText(PasswordActivity.this, "你选择了取消" , Toast.LENGTH_SHORT).show();
					}
				});
				
				builder.create().show(); 
				
				return true;
			}
		});
		
		btnAddPassword = (Button) findViewById(R.id.btnAddPassword);
		
		btnAddPassword.setOnClickListener(new OnClickListener() {
			
			@Override
			public void onClick(View arg0) {
				Intent intent = new Intent();
                intent.setClass(PasswordActivity.this, AddPasswordActivity.class);
                startActivityForResult(intent, 1);
			}
		});
	}
	
	private void showGridViewData(){
		listPassword = new ArrayList<sqliteDataBase.Model.Password>();
		
		Cursor cursor = bllPassword.query();
		if(cursor.getCount()!=0)
		{
			Log.i("tag", "密码数据："+cursor.getCount());
			while(cursor.moveToNext()){
				String name;
				String password;
				String soundFileName;
				
	    		int nameIndex = cursor.getColumnIndex("name");
	    		int passwordIndex = cursor.getColumnIndex("passWord");
	    		int soundFileNameIndex = cursor.getColumnIndex("soundFileName");
	    		
	    		name = cursor.getString(nameIndex);
	    		password = cursor.getString(passwordIndex);
	    		soundFileName = cursor.getString(soundFileNameIndex);

	    		Log.i("tag", "密码名"+name);
	    		sqliteDataBase.Model.Password modelPassword = new Password(name, password, soundFileName);
	    		listPassword.add(modelPassword);
			}
			gridViewPassword.setAdapter(new PasswordAdapter(PasswordActivity.this,listPassword)); 
			
		}
		else{
			Log.i("tag", "没有密码数据");
			TextView emptyView = new TextView(PasswordActivity.this);  
            emptyView.setLayoutParams(new LayoutParams(LayoutParams.FILL_PARENT, LayoutParams.FILL_PARENT));  
            emptyView.setText("没有密码数据，请先添加密码数据");  
            emptyView.setGravity(Gravity.CENTER_HORIZONTAL|Gravity.CENTER_VERTICAL);
            emptyView.setVisibility(View.GONE);  
            ((ViewGroup)gridViewPassword.getParent()).addView(emptyView);  
            gridViewPassword.setEmptyView(emptyView);
		}
	}
	@Override 
	protected void onActivityResult(int requestCode,int resultCode,Intent data){
		super.onActivityResult(requestCode,resultCode,data);   
		if(resultCode==1){  
			showGridViewData();
		}
	}  
}
