package com.example.shenghuobang.Charge;


import java.util.Date;

import com.example.shenghuobang.R;

import android.content.Context;
import android.util.AttributeSet;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.MotionEvent;
import android.view.View;
import android.view.ViewGroup;
import android.view.animation.LinearInterpolator;
import android.view.animation.RotateAnimation;
import android.widget.AbsListView;
import android.widget.AbsListView.OnScrollListener;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.ListView;
import android.widget.ProgressBar;
import android.widget.TextView;


/**
 * è¯¥ç±»ä¸»è¦æ˜¯å®Œæˆ?å¤´éƒ¨éƒ¨åˆ†çš„åŠŸèƒ½å°è£? * 
 * ä¸?¸ªå¯ä»¥ç›‘å¬ListViewæ˜¯å¦æ»šåŠ¨åˆ°æœ€é¡¶éƒ¨æˆ–æœ€åº•éƒ¨çš„è‡ªå®šä¹‰æ§ä»¶
 * åªèƒ½ç›‘å¬ç”±è§¦æ‘¸äº§ç”Ÿçš„ï¼Œå¦‚æœæ˜¯ListViewæœ¬èº«Flyingå¯¼è‡´çš„ï¼Œåˆ™ä¸èƒ½ç›‘å?/br> å¦‚æœåŠ ä»¥æ”¹è¿›ï¼Œå¯ä»¥å®ç°ç›‘å¬scrollæ»šåŠ¨çš„å…·ä½“ä½ç½®ç­‰
 * 
 */

public class ScrollOverListView extends ListView implements OnScrollListener {

	private int mLastY;
	
	private int mBottomPosition;

	private static final String TAG = "listview";

	/**æ¾å¼€æ›´æ–°**/
	private final static int RELEASE_To_REFRESH = 0;
	/**ä¸‹æ‹‰æ›´æ–°**/
	private final static int PULL_To_REFRESH = 1;
	/**æ›´æ–°ä¸?*/
	private final static int REFRESHING = 2;
	/**æ—?*/
	private final static int DONE = 3;
	/**åŠ è½½ä¸?*/
	private final static int LOADING = 4;
	/**å®é™…çš„paddingçš„è·ç¦»ä¸ç•Œé¢ä¸Šåç§»è·ç¦»çš„æ¯”ä¾‹**/
	private final static int RATIO = 3;
	
	private LayoutInflater inflater;
	/**å¤´éƒ¨åˆ·æ–°çš„å¸ƒå±?*/
	private LinearLayout headView;
	/**å¤´éƒ¨æ˜¾ç¤ºä¸‹æ‹‰åˆ·æ–°ç­‰çš„æ§ä»¶**/
	private TextView tipsTextview;
	/**åˆ·æ–°æ§ä»¶**/
	private TextView lastUpdatedTextView;
	/**ç®­å¤´å›¾æ ‡**/
	private ImageView arrowImageView;
	/**å¤´éƒ¨æ»šåŠ¨æ?*/
	private ProgressBar progressBar;
	/**æ˜¾ç¤ºåŠ¨ç”»**/
	private RotateAnimation animation;
	/**å¤´éƒ¨å›é?æ˜¾ç¤ºåŠ¨ç”»**/
	private RotateAnimation reverseAnimation;
	/** ç”¨äºä¿è¯startYçš„å?åœ¨ä¸€ä¸ªå®Œæ•´çš„touchäº‹ä»¶ä¸­åªè¢«è®°å½•ä¸€æ¬?*/
	private boolean isRecored;
	/**å¤´éƒ¨é«˜åº¦**/
	private int headContentHeight;
	/**å¼?§‹çš„Yåæ ‡**/
	private int startY;
	/**ç¬¬ä¸€ä¸ªitem**/
	private int firstItemIndex;
	/**çŠ¶æ?**/
	private int state;
	
	private boolean isBack;
	/**æ˜¯å¦è¦ä½¿ç”¨ä¸‹æ‹‰åˆ·æ–°åŠŸèƒ?*/
	public boolean showRefresh = true;

	public static boolean canRefleash = true;

	public ScrollOverListView(Context context, AttributeSet attrs, int defStyle) {
		super(context, attrs, defStyle);
		init(context);
	}

	public ScrollOverListView(Context context, AttributeSet attrs) {
		super(context, attrs);
		init(context);
	}

	public ScrollOverListView(Context context) {
		super(context);
		init(context);
	}

	/**å‡ºäº‹åŒ–æ§ä»?*/
	private void init(Context context) {
		mBottomPosition = 0;
		setCacheColorHint(0);
		inflater = LayoutInflater.from(context);

		headView = (LinearLayout) inflater.inflate(R.layout.pull_down_head,
				null);
		arrowImageView = (ImageView) headView
				.findViewById(R.id.head_arrowImageView);
		arrowImageView.setMinimumWidth(70);
		arrowImageView.setMinimumHeight(50);
		progressBar = (ProgressBar) headView
				.findViewById(R.id.head_progressBar);
		tipsTextview = (TextView) headView.findViewById(R.id.head_tipsTextView);
		lastUpdatedTextView = (TextView) headView
				.findViewById(R.id.head_lastUpdatedTextView);

		measureView(headView);

		headContentHeight = headView.getMeasuredHeight();

		headView.setPadding(0, -1 * headContentHeight, 0, 0);
		headView.invalidate();

		/**åˆ—è¡¨æ·»åŠ å¤´éƒ¨**/
		addHeaderView(headView, null, false);

		setOnScrollListener(this);

		animation = new RotateAnimation(0, -180,
				RotateAnimation.RELATIVE_TO_SELF, 0.5f,
				RotateAnimation.RELATIVE_TO_SELF, 0.5f);
		animation.setInterpolator(new LinearInterpolator());
		animation.setDuration(250);
		animation.setFillAfter(true);
		

		reverseAnimation = new RotateAnimation(-180, 0,
				RotateAnimation.RELATIVE_TO_SELF, 0.5f,
				RotateAnimation.RELATIVE_TO_SELF, 0.5f);
		
		reverseAnimation.setInterpolator(new LinearInterpolator());
		reverseAnimation.setDuration(200);
		reverseAnimation.setFillAfter(true);
		
		state = DONE;
	}

	/**è§¦æ‘¸äº‹ä»¶çš„å¤„ç?*/
	@Override
	public boolean onTouchEvent(MotionEvent ev) {

		final int action = ev.getAction();
		final int y = (int) ev.getRawY();
		cancelLongPress();
		switch (action) {
		case MotionEvent.ACTION_DOWN: {  //æŒ‰ä¸‹çš„æ—¶å€?			
			if (firstItemIndex == 0 && !isRecored) {
				isRecored = true;
				startY = (int) ev.getY();
				Log.v(TAG, "åœ¨downæ—¶å?è®°å½•å½“å‰ä½ç½®â€?");
			}
			// ===========================
			mLastY = y;
			final boolean isHandled = mOnScrollOverListener.onMotionDown(ev);
			if (isHandled) {
				mLastY = y;
				return isHandled;
			}
			break;
		}

		case MotionEvent.ACTION_MOVE: {   //æ‰‹æŒ‡æ­£åœ¨ç§»åŠ¨çš„æ—¶å€?			int tempY = (int) ev.getY();
			if (showRefresh) {
				
				if (!isRecored && firstItemIndex == 0) {
					Log.v(TAG, "åœ¨moveæ—¶å?è®°å½•ä¸‹ä½ç½?);
					isRecored = true;
					startY = tempY;
				}
				if (state != REFRESHING && isRecored && state != LOADING) {

					// ä¿è¯åœ¨è®¾ç½®paddingçš„è¿‡ç¨‹ä¸­ï¼Œå½“å‰çš„ä½ç½®ä¸?›´æ˜¯åœ¨headï¼Œå¦åˆ™å¦‚æœå½“åˆ—è¡¨è¶…å‡ºå±å¹•çš„è¯ï¼Œå½“åœ¨ä¸Šæ¨çš„æ—¶å?ï¼Œåˆ—è¡¨ä¼šåŒæ—¶è¿›è¡Œæ»šåŠ¨

					// å¯ä»¥æ¾æ‰‹å»åˆ·æ–°äº†
					if (state == RELEASE_To_REFRESH) {

						setSelection(0);

						// å¾?¸Šæ¨äº†ï¼Œæ¨åˆ°äº†å±å¹•è¶³å¤Ÿæ©ç›–headçš„ç¨‹åº¦ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ¨åˆ°å…¨éƒ¨æ©ç›–çš„åœ°æ­¥
						if (((tempY - startY) / RATIO < headContentHeight)
								&& (tempY - startY) > 0) {
							state = PULL_To_REFRESH;
							changeHeaderViewByState();

						}
						// ä¸?¸‹å­æ¨åˆ°é¡¶äº?						else if (tempY - startY <= 0) {
							state = DONE;
							changeHeaderViewByState();

							Log.v(TAG, "ç”±æ¾å¼?ˆ·æ–°çŠ¶æ€è½¬å˜åˆ°doneçŠ¶æ?");
						}
						// å¾?¸‹æ‹‰äº†ï¼Œæˆ–è€…è¿˜æ²¡æœ‰ä¸Šæ¨åˆ°å±å¹•é¡¶éƒ¨æ©ç›–headçš„åœ°æ­?						else {
							// ä¸ç”¨è¿›è¡Œç‰¹åˆ«çš„æ“ä½œï¼Œåªç”¨æ›´æ–°paddingTopçš„å?å°±è¡Œäº?						}
					}
					// è¿˜æ²¡æœ‰åˆ°è¾¾æ˜¾ç¤ºæ¾å¼?ˆ·æ–°çš„æ—¶å?,DONEæˆ–è?æ˜¯PULL_To_REFRESHçŠ¶æ?
					if (state == PULL_To_REFRESH) {

						setSelection(0);

						// ä¸‹æ‹‰åˆ°å¯ä»¥è¿›å…¥RELEASE_TO_REFRESHçš„çŠ¶æ€?						if ((tempY - startY) / RATIO >= headContentHeight) {
							state = RELEASE_To_REFRESH;
							isBack = true;
							changeHeaderViewByState();

							Log.v(TAG, "ç”±doneæˆ–è?ä¸‹æ‹‰åˆ·æ–°çŠ¶æ?è½¬å˜åˆ°æ¾å¼?ˆ·æ–?);
						}
						// ä¸Šæ¨åˆ°é¡¶äº?						else if (tempY - startY <= 0) {
							state = DONE;
							changeHeaderViewByState();

							Log.v(TAG, "ç”±DOneæˆ–è?ä¸‹æ‹‰åˆ·æ–°çŠ¶æ?è½¬å˜åˆ°doneçŠ¶æ?");
						}
					}

					// doneçŠ¶æ?ä¸?					if (state == DONE) {
						if (tempY - startY > 0) {
							state = PULL_To_REFRESH;
							changeHeaderViewByState();
						}
					}

					// æ›´æ–°headViewçš„size
					if (state == PULL_To_REFRESH) {
						headView.setPadding(0, -1 * headContentHeight
								+ (tempY - startY) / RATIO, 0, 0);
					}

					// æ›´æ–°headViewçš„paddingTop
					if (state == RELEASE_To_REFRESH) {
						headView.setPadding(0, (tempY - startY) / RATIO
								- headContentHeight, 0, 0);
					}

				}
			}
			// ==============================================
			final int childCount = getChildCount();
			if (childCount == 0)
				return super.onTouchEvent(ev);
			final int itemCount = getAdapter().getCount() - mBottomPosition;
			final int deltaY = y - mLastY;
			final int lastBottom = getChildAt(childCount - 1).getBottom();
			final int end = getHeight() - getPaddingBottom();

			final int firstVisiblePosition = getFirstVisiblePosition();

			final boolean isHandleMotionMove = mOnScrollOverListener
					.onMotionMove(ev, deltaY);

			if (isHandleMotionMove) {
				mLastY = y;
				return true;
			}

			/** åˆ°è¾¾åº•éƒ¨ *  åˆ°è¾¾åº•éƒ¨çš„äº‹ä»¶åœ¨å¦å¤–ä¸?¸ªç±»æ‰§è¡?*/
			if (firstVisiblePosition + childCount >= itemCount
					&& lastBottom <= end && deltaY < 0) {
				final boolean isHandleOnListViewBottomAndPullDown;
				isHandleOnListViewBottomAndPullDown = mOnScrollOverListener
						.onListViewBottomAndPullUp(deltaY);
				if (isHandleOnListViewBottomAndPullDown) {
					mLastY = y;
					return true;
				}
			}
			break;
		}

		case MotionEvent.ACTION_UP: {   //æ‰‹æŒ‡æŠ¬èµ·æ¥çš„æ—¶å?
			if (state != REFRESHING && state != LOADING) {
				if (state == DONE) {
					// ä»?¹ˆéƒ½ä¸å?				}
				if (state == PULL_To_REFRESH) {
					state = DONE;
					changeHeaderViewByState();
					Log.v(TAG, "ç”±ä¸‹æ‹‰åˆ·æ–°çŠ¶æ€ï¼Œåˆ°doneçŠ¶æ?");
				}

				if (state == RELEASE_To_REFRESH) {
					state = REFRESHING;
					changeHeaderViewByState();

					canRefleash = true;

					Log.v(TAG, "ç”±æ¾å¼?ˆ·æ–°çŠ¶æ€ï¼Œåˆ°doneçŠ¶æ?");
				}
			}

			isRecored = false;
			isBack = false;

			// /======================
			final boolean isHandlerMotionUp = mOnScrollOverListener
					.onMotionUp(ev);
			if (isHandlerMotionUp) {
				mLastY = y;
				return true;
			}
			break;
		}
		}
		mLastY = y;
		return super.onTouchEvent(ev);
	}
	
	
	
	
	
	
	
	

	/** ç©ºçš„ */
	private OnScrollOverListener mOnScrollOverListener = new OnScrollOverListener() {

		@Override
		public boolean onListViewTopAndPullDown(int delta) {
			return false;
		}

		@Override
		public boolean onListViewBottomAndPullUp(int delta) {
			return false;
		}

		@Override
		public boolean onMotionDown(MotionEvent ev) {
			return false;
		}

		@Override
		public boolean onMotionMove(MotionEvent ev, int delta) {
			return false;
		}

		@Override
		public boolean onMotionUp(MotionEvent ev) {
			return false;
		}

	};

	// =============================== public method
	/**
	 * å¯ä»¥è‡ªå®šä¹‰å…¶ä¸­ä¸€ä¸ªæ¡ç›®ä¸ºå¤´éƒ¨ï¼Œå¤´éƒ¨è§¦å‘çš„äº‹ä»¶å°†ä»¥è¿™ä¸ªä¸ºå‡†ï¼Œé»˜è®¤ä¸ºç¬¬ä¸€ä¸?	 * 
	 * @param index  æ­£æ•°ç¬¬å‡ ä¸ªï¼Œå¿…é¡»åœ¨æ¡ç›®æ•°èŒƒå›´ä¹‹å†…
	 */
	public void setTopPosition(int index) {
		if (getAdapter() == null)
			throw new NullPointerException(
					"You must set adapter before setTopPosition!");
		if (index < 0)
			throw new IllegalArgumentException("Top position must > 0");
	}

	/**
	 * å¯ä»¥è‡ªå®šä¹‰å…¶ä¸­ä¸€ä¸ªæ¡ç›®ä¸ºå°¾éƒ¨ï¼Œå°¾éƒ¨è§¦å‘çš„äº‹ä»¶å°†ä»¥è¿™ä¸ªä¸ºå‡†ï¼Œé»˜è®¤ä¸ºæœ?ä¸?¸ª
	 * 
	 * @param index  å€’æ•°ç¬¬å‡ ä¸ªï¼Œå¿…é¡»åœ¨æ¡ç›®æ•°èŒƒå›´ä¹‹å†…
	 */
	public void setBottomPosition(int index) {
		if (getAdapter() == null)
			throw new NullPointerException(
					"You must set adapter before setBottonPosition!");
		if (index < 0)
			throw new IllegalArgumentException("Bottom position must > 0");

		mBottomPosition = index;
	}

	/**
	 * è®¾ç½®è¿™ä¸ªListenerå¯ä»¥ç›‘å¬æ˜¯å¦åˆ°è¾¾é¡¶ç«¯ï¼Œæˆ–è€…æ˜¯å¦åˆ°è¾¾ä½ç«¯ç­‰äº‹ä»¶</br>
	 * 
	 * @see OnScrollOverListener
	 */
	public void setOnScrollOverListener(
			OnScrollOverListener onScrollOverListener) {
		mOnScrollOverListener = onScrollOverListener;
	}

	/**
	 * æ»šåŠ¨ç›‘å¬æ¥å£
	 * 
	 * @see ScrollOverListView#setOnScrollOverListener(OnScrollOverListener)
	 * 
	 */
	public interface OnScrollOverListener {
		/**
		 * åˆ°è¾¾æœ?¡¶éƒ¨è§¦å?		 * 
		 * @param delta
		 *            æ‰‹æŒ‡ç‚¹å‡»ç§»åŠ¨äº§ç”Ÿçš„åç§»é‡
		 * @return
		 */
		boolean onListViewTopAndPullDown(int delta);

		/**
		 * åˆ°è¾¾æœ?º•éƒ¨è§¦å?		 * 
		 * @param delta
		 *            æ‰‹æŒ‡ç‚¹å‡»ç§»åŠ¨äº§ç”Ÿçš„åç§»é‡
		 * @return
		 */
		boolean onListViewBottomAndPullUp(int delta);

		/**
		 * æ‰‹æŒ‡è§¦æ‘¸æŒ‰ä¸‹è§¦å‘ï¼Œç›¸å½“äº{@link MotionEvent#ACTION_DOWN}
		 * 
		 * @return è¿”å›trueè¡¨ç¤ºè‡ªå·±å¤„ç†
		 * @see View#onTouchEvent(MotionEvent)
		 */
		boolean onMotionDown(MotionEvent ev);

		/**
		 * æ‰‹æŒ‡è§¦æ‘¸ç§»åŠ¨è§¦å‘ï¼Œç›¸å½“äº{@link MotionEvent#ACTION_MOVE}
		 * 
		 * @return è¿”å›trueè¡¨ç¤ºè‡ªå·±å¤„ç†
		 * @see View#onTouchEvent(MotionEvent)
		 */
		boolean onMotionMove(MotionEvent ev, int delta);

		/**
		 * æ‰‹æŒ‡è§¦æ‘¸åæèµ·è§¦å‘ï¼Œç›¸å½“äº{@link MotionEvent#ACTION_UP}
		 * 
		 * @return è¿”å›trueè¡¨ç¤ºè‡ªå·±å¤„ç†
		 * @see View#onTouchEvent(MotionEvent)
		 */
		boolean onMotionUp(MotionEvent ev);

	}

	
	@Override
	public void onScroll(AbsListView arg0, int firstVisiableItem, int arg2,
			int arg3) {
		firstItemIndex = firstVisiableItem;
		
	}

	@Override
	public void onScrollStateChanged(AbsListView view, int scrollState) {

	}

	// æ­¤æ–¹æ³•ç›´æ¥ç…§æ¬è‡ªç½‘ç»œä¸Šçš„ä¸?¸ªä¸‹æ‹‰åˆ·æ–°çš„demoï¼Œæ­¤å¤„æ˜¯â€œä¼°è®¡â?headViewçš„widthä»¥åŠheight
	private void measureView(View child) {
		ViewGroup.LayoutParams p = child.getLayoutParams();
		if (p == null) {
			p = new ViewGroup.LayoutParams(ViewGroup.LayoutParams.FILL_PARENT,
					ViewGroup.LayoutParams.WRAP_CONTENT);
		}
		int childWidthSpec = ViewGroup.getChildMeasureSpec(0, 0 + 0, p.width);
		int lpHeight = p.height;
		int childHeightSpec;
		if (lpHeight > 0) {
			childHeightSpec = MeasureSpec.makeMeasureSpec(lpHeight,
					MeasureSpec.EXACTLY);
		} else {
			childHeightSpec = MeasureSpec.makeMeasureSpec(0,
					MeasureSpec.UNSPECIFIED);
		}
		child.measure(childWidthSpec, childHeightSpec);
	}
	
	
	
	
	
	
	

	public void onRefreshComplete() {
		state = DONE;
		lastUpdatedTextView.setText("æœ?¿‘æ›´æ–°:" + new Date().toLocaleString());
		changeHeaderViewByState();
	}

	// å½“çŠ¶æ€æ”¹å˜æ—¶å€™ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼Œä»¥æ›´æ–°ç•Œé?	private void changeHeaderViewByState() {
		switch (state) {
		case RELEASE_To_REFRESH:
			arrowImageView.setVisibility(View.VISIBLE);
			progressBar.setVisibility(View.GONE);
			tipsTextview.setVisibility(View.VISIBLE);
			lastUpdatedTextView.setVisibility(View.VISIBLE);

			arrowImageView.clearAnimation();
			arrowImageView.startAnimation(animation);

			tipsTextview.setText("æ¾å¼€åˆ·æ–°");

			Log.v(TAG, "å½“å‰çŠ¶æ?ï¼Œæ¾å¼?ˆ·æ–?);
			break;
		case PULL_To_REFRESH:
			progressBar.setVisibility(View.GONE);
			tipsTextview.setVisibility(View.VISIBLE);
			lastUpdatedTextView.setVisibility(View.VISIBLE);
			arrowImageView.clearAnimation();
			arrowImageView.setVisibility(View.VISIBLE);
			// æ˜¯ç”±RELEASE_To_REFRESHçŠ¶æ?è½¬å˜æ¥çš„
			if (isBack) {
				isBack = false;
				arrowImageView.clearAnimation();
				arrowImageView.startAnimation(reverseAnimation);

				tipsTextview.setText("ä¸‹æ‹‰åˆ·æ–°");
			} else {
				tipsTextview.setText("ä¸‹æ‹‰åˆ·æ–°");
			}
			Log.v(TAG, "å½“å‰çŠ¶æ?ï¼Œä¸‹æ‹‰åˆ·æ–?);
			break;

		case REFRESHING:

			headView.setPadding(0, 0, 0, 0);
			progressBar.setVisibility(View.VISIBLE);
			arrowImageView.clearAnimation();
			arrowImageView.setVisibility(View.GONE);
			tipsTextview.setText("æ­£åœ¨åˆ·æ–°...");
			lastUpdatedTextView.setVisibility(View.VISIBLE);

			Log.v(TAG, "å½“å‰çŠ¶æ?,æ­£åœ¨åˆ·æ–°...");
			break;
		case DONE:
			headView.setPadding(0, -1 * headContentHeight, 0, 0);
			progressBar.setVisibility(View.GONE);
			arrowImageView.clearAnimation();
			arrowImageView.setImageResource(R.drawable.pull_down_arrow);
			tipsTextview.setText("ä¸‹æ‹‰åˆ·æ–°");
			lastUpdatedTextView.setVisibility(View.VISIBLE);

			Log.v(TAG, "å½“å‰çŠ¶æ?ï¼Œdone");
			break;
		}
	}
}
